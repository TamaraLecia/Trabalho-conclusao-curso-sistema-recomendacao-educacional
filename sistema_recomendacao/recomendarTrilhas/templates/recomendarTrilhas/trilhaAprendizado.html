{% extends 'indexRecomendarTrilhaTimeline.html' %}
{% load dict_utils %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css1/trilhaAprendizado.css' %}?v=30">

<div class="container-fluid">
  <h2 class="text-center my-5 mb-5"></h2>

  <!-- Timeline de tÃ³picos e capÃ­tulos -->
  <div class="duo-timeline">
    {% for topico in topicos %}
      <div id="topico-{{ topico.id }}" class="duo-step {% if forloop.counter|divisibleby:2 %}right{% else %}left{% endif %}">
        <div class=" card-topico custom-card card-{{ topico.status }}">
          
          <!-- CabeÃ§alho do tÃ³pico -->
          <div class="card-header border d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <span class="fs-4 fw-bold mb-2 mb-md-0">
              {{ topico.nome }}
              {% if not topicos_liberados|dict_get:topico.id %}
                <span class="ms-2">ðŸ”’</span>
              {% endif %}
            </span>
            <small>
              {{ progresso_topicos|dict_get:topico.id|dict_get:"concluidos" }} /
              {{ progresso_topicos|dict_get:topico.id|dict_get:"total" }} concluÃ­dos
            </small>
          </div>

          <!-- Corpo do card -->
          <div class="card-body">
            <ul class="list-group">
              {% for capitulo in topico.capitulos.all|dictsort:"id" %}
                {% with anterior=anterior_por_capitulo|dict_get:capitulo.id concluido=progresso|dict_get:capitulo.id %}
                  <li class="list-group-item">
                    <div class="row align-items-center g-2">
                      
                      <!-- Texto do capÃ­tulo -->
                      <div class="col">
                        <span class="fw-semibold d-block">{{ capitulo.nome }}</span>
                        <span class="badge bg-info text-dark nivel-badge">{{ capitulo.get_nivel_display }}</span>
                      </div>

                      <!-- BotÃµes / AÃ§Ãµes -->
                      <div class="col-12 col-md-auto">
                        {% if topicos_liberados|dict_get:topico.id %}
                          {% if concluido %}
                            <div class="d-flex flex-column flex-sm-row gap-2">
                              <span class="badge bg-success">âœ” ConcluÃ­do</span>
                              <a href="{% url 'verCapitulo' capitulo.id %}" class="btn btn-sm btn-outline-primary  btn-fixed" style="color: black;">
                                Reassistir
                              </a>
                            </div>
                          {% else %}
                            {% if not anterior or progresso|dict_get:anterior %}
                              <a href="{% url 'verCapitulo' capitulo.id %}" class="btn btn-sm btn-primary btn-fixed">Acessar</a>
                            {% else %}
                              <button class="btn btn-sm btn-secondary btn-fixed" disabled>ðŸ”’ Bloqueado</button>
                            {% endif %}
                          {% endif %}
                        {% else %}
                          <span class="text-muted">CapÃ­tulo bloqueado ðŸ”’</span>
                        {% endif %}
                      </div>

                    </div>
                  </li>
                {% endwith %}
              {% endfor %}
            </ul>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Modal de conclusÃ£o da trilha -->
  <div class="modal fade" id="trilhaConcluidaModal" tabindex="-1" aria-labelledby="trilhaConcluidaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title text-white" id="trilhaConcluidaLabel">ParabÃ©ns! ðŸŽ‰</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          VocÃª concluiu a trilha <strong>{{ trilha.nome }}</strong>.<br>
          O que deseja fazer agora?
        </div>
        <div class="modal-footer d-flex flex-column gap-2">
          <a href="{% url 'novaRecomendacao' trilha.id %}" class="btn btn-primary w-100">
            Fazer nova trilha recomendada
          </a>
          <a href="{% url 'questionario' %}" class="btn btn-warning w-100">
            Responder o questionÃ¡rio
          </a>
          <a href="{% url 'indexUsuarioComun' %}" class="btn btn-secondary w-100">
            Voltar ao perfil
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div style="margin-bottom: 5vh;"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("concluida") === "1") {
      let modal = new bootstrap.Modal(document.getElementById('trilhaConcluidaModal'));
      modal.show();
    }
  });

  // Script para recarregar a pÃ¡gina e monstrar para o usuÃ¡rio em que lugar ele estava na pÃ¡gina
  document.addEventListener("DOMContentLoaded", () =>{
    const ultimoTopicoId = "{{ultimo_topico_id|default:'' }}";
    if (ultimoTopicoId){
      const el = document.getElementById("topico-" + ultimoTopicoId);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }
  });
</script>

{% endblock %}
